name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup NuGet sources
        env:
          NUGET_PAT: ${{ secrets.NUGET_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Настраиваем аутентификацию для GitHub Packages
          # Используем NUGET_PAT если установлен, иначе GITHUB_TOKEN
          TOKEN="${NUGET_PAT:-$GITHUB_TOKEN}"
          
          # Удаляем существующие источники, если они есть (игнорируем ошибки)
          dotnet nuget remove source github 2>/dev/null || true
          dotnet nuget remove source nuget.org 2>/dev/null || true
          
          # Добавляем nuget.org как источник для публичных пакетов
          dotnet nuget add source https://api.nuget.org/v3/index.json \
            --name nuget.org || true
          
          # Добавляем GitHub Packages
          dotnet nuget add source https://nuget.pkg.github.com/WorkTrack-Team/index.json \
            --name github \
            --username BelousovMike \
            --password "$TOKEN" \
            --store-password-in-clear-text
          
          # Проверяем, что источники добавлены
          echo "Доступные источники NuGet:"
          dotnet nuget list source
          
          # Используем существующий nuget.config из репозитория
          # Учетные данные уже добавлены через dotnet nuget add source
      - name: Restore dependencies
        run: dotnet restore WorkTrack.Common.DependencyInjection.sln

      - name: Build
        run: dotnet build WorkTrack.Common.DependencyInjection.sln --no-restore --configuration Release

      - name: Run tests
        run: dotnet test WorkTrack.Common.DependencyInjection.sln --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage" --results-directory:./TestResults

      - name: Generate coverage report
        if: always()
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import glob
          pattern = "TestResults/*/coverage.cobertura.xml"
          files = glob.glob(pattern)
          if files:
              files.sort(reverse=True)
              tree = ET.parse(files[0])
              root = tree.getroot()
              line_rate = float(root.attrib.get('line-rate', 0)) * 100
              branch_rate = float(root.attrib.get('branch-rate', 0)) * 100
              print(f"Покрытие строк: {line_rate:.2f}%")
              print(f"Покрытие ветвей: {branch_rate:.2f}%")
          EOF
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: '**/coverage.cobertura.xml'
          fail_ci_if_error: false

      - name: Publish NuGet package
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: dotnet pack src/WorkTrack.Common.DependencyInjection/WorkTrack.Common.DependencyInjection.csproj --no-build --configuration Release --output ./nupkg /p:TreatWarningsAsErrors=false /p:NuGetTreatWarningsAsErrors=false
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to GitHub Packages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          dotnet nuget push ./nupkg/*.nupkg \
            --source https://nuget.pkg.github.com/WorkTrack-Team/index.json \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup NuGet sources
        env:
          NUGET_PAT: ${{ secrets.NUGET_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Настраиваем аутентификацию для GitHub Packages
          # Используем NUGET_PAT если установлен, иначе GITHUB_TOKEN
          TOKEN="${NUGET_PAT:-$GITHUB_TOKEN}"
          
          # Удаляем существующие источники, если они есть (игнорируем ошибки)
          dotnet nuget remove source github 2>/dev/null || true
          dotnet nuget remove source nuget.org 2>/dev/null || true
          
          # Добавляем nuget.org как источник для публичных пакетов
          dotnet nuget add source https://api.nuget.org/v3/index.json \
            --name nuget.org || true
          
          # Добавляем GitHub Packages
          dotnet nuget add source https://nuget.pkg.github.com/WorkTrack-Team/index.json \
            --name github \
            --username BelousovMike \
            --password "$TOKEN" \
            --store-password-in-clear-text
          
          # Проверяем, что источники добавлены
          echo "Доступные источники NuGet:"
          dotnet nuget list source
          
          # Используем существующий nuget.config из репозитория
          # Учетные данные уже добавлены через dotnet nuget add source
      - name: Restore dependencies
        run: dotnet restore WorkTrack.Common.DependencyInjection.sln

      - name: Run analyzers
        run: dotnet build WorkTrack.Common.DependencyInjection.sln --no-restore --configuration Release -warnaserror